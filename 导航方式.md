# PCT Planner 导航方式说明

PCT Planner 采用分层导航架构，主要包含**全局规划（Global Planning）**和**局部规划（Local Planning）**两部分。全局规划基于点云层析成像（Point Cloud Tomography）生成三维全局路径，局部规划则采用纯跟踪（Pure Pursuit）算法进行路径跟踪控制。

## 1. 全局规划 (Global Planning)

全局规划负责在三维复杂环境（如多层建筑、螺旋坡道）中生成从起点到终点的无碰撞路径。

### 核心原理
- **点云层析成像 (Tomography)**: 将环境的点云数据（`.pcd`）转换为层析图（Tomogram），以理解环境的三维结构和连通性。
- **路径搜索**: 基于层析图进行路径搜索，生成包含三维坐标 (x, y, z) 的全局路径。

### 操作流程
1. **构建层析图**:
   ```bash
   cd tomography/scripts/
   python3 tomography.py --scene <SceneName>
   ```
   该步骤读取 `.pcd` 文件并生成环境的层析表达。

2. **生成路径**:
   ```bash
   cd planner/scripts/
   python3 plan.py --scene <SceneName>
   ```
   规划器计算路径并通过 ROS 话题 `/pct_path` 发布 `nav_msgs/Path` 消息。

## 2. 局部规划 (Local Planning)

局部规划器运行在机器人上，负责接收全局路径并生成实时的速度控制指令。

- **节点脚本**: `planner/scripts/local_planner.py`
- **控制算法**: 改进的纯跟踪算法 (Pure Pursuit)

### 核心逻辑
1. **接收路径**: 订阅 `/pct_path` 话题获取全局路径点列表。
2. **定位更新**: 订阅 `/localization` 话题 (`nav_msgs/Odometry`) 获取机器人当前位姿。
3. **寻找目标点**:
   - 计算机器人当前位置在路径上的最近点。
   - 根据**前瞻距离 (Lookahead Distance)** 在路径前方寻找目标点 (Target Point)。
4. **速度计算**:
   - **角速度**: 根据机器人当前朝向与目标点方位的角度差计算，采用 P 控制器 (`kp_angular`)。若角度偏差过大 (>45°)，会优先原地旋转。
   - **线速度**: 根据与目标点的距离动态调整，并在大角度转向时自动减速。
5. **发布指令**: 通过 `/cmd_vel` 话题发布 `geometry_msgs/Twist` 控制指令。

### 关键话题接口

| 类型 | 话题名称 | 消息类型 | 说明 |
|------|----------|----------|------|
| **订阅** | `/pct_path` | `nav_msgs/Path` | 全局路径输入 |
| **订阅** | `/localization` | `nav_msgs/Odometry` | 机器人实时位姿 |
| **订阅** | `/motion_control` | `std_msgs/Bool` | 运动启停控制 (True: 允许运动, False: 停止) |
| **发布** | `/cmd_vel` | `geometry_msgs/Twist` | 速度控制指令 |
| **发布** | `/target_point` | `geometry_msgs/Point` | 当前跟踪的目标点 (可视化用) |
| **发布** | `/arrival_status` | `std_msgs/String` | 到达终点状态通知 |

## 3. 特殊功能：楼梯模式 (Stair Mode)

局部规划器包含针对多层环境的特殊逻辑：

- **高程检测**: 规划器会检测路径前方的垂直高度变化 (`z_delta`)。
- **模式切换**: 当检测到显著的高度变化（如上楼梯）时，会触发楼梯模式。
- **速度调整**: 在楼梯模式下，可能会强制使用特定的速度策略（如 `min_stair_speed`），以确保机器人有足够的动力通过斜坡或楼梯。
- **WebSocket 通信**: 如果启用 (`enable_stair_ws`)，规划器还会通过 WebSocket 与外部系统通信，可能用于调整机器人步态（针对足式机器人）。

## 4. 参数配置

主要参数可在 `local_planner.py` 或对应的 launch 文件中调整：

- `lookahead_distance`: 前瞻距离，影响跟踪的平滑度。
- `max_speed` / `max_walk_speed`: 最大移动速度。
- `kp_angular`: 转向控制比例系数。
- `z_window_distance`: 用于检测高度变化的窗口距离。
